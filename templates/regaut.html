{% extends "base.html" %}
{% load static %}

{% block title %}Авторизация{% endblock %}

{% block content %}
<div class="auth-container">
    <!-- Форма входа -->
    <form id="login-form" class="auth-form">
        <h2>Вход</h2>
        <div class="mb-3">
            <label for="login-username" class="form-label">Имя пользователя</label>
            <input type="text" id="login-username" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="login-password" class="form-label">Пароль</label>
            <input type="password" id="login-password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Войти</button>
        <p class="mt-3">
            Нет аккаунта? <a href="#" onclick="showRegister()">Зарегистрируйтесь</a>
        </p>
    </form>

    <!-- Форма регистрации -->
    <form id="register-form" class="auth-form" style="display:none">
        <h2>Регистрация</h2>
        <div class="mb-3">
            <label for="reg-username" class="form-label">Имя пользователя</label>
            <input type="text" id="reg-username" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="reg-email" class="form-label">Email</label>
            <input type="email" id="reg-email" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="reg-password" class="form-label">Пароль</label>
            <input type="password" id="reg-password" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="reg-password2" class="form-label">Повторите пароль</label>
            <input type="password" id="reg-password2" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
        <p class="mt-3">
            Уже есть аккаунт? <a href="#" onclick="showLogin()">Войдите</a>
        </p>
    </form>
    <div id="auth-message" class="alert mt-3" style="display:none"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_BASE_URL = '/api/auth/';
    
    // Переключение между формами
    function showRegister() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
    }
    
    function showLogin() {
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
    }

    // Обработка регистрации
    document.getElementById('register-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            username: document.getElementById('reg-username').value,
            email: document.getElementById('reg-email').value,
            password: document.getElementById('reg-password').value,
            password2: document.getElementById('reg-password2').value
        };

        try {
            const response = await fetch(API_BASE_URL + 'register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            
            if (response.ok) {
                showMessage('Регистрация успешна!', 'success');
                this.reset();
                showLogin();
            } else {
                const error = data.email?.[0] || data.username?.[0] || data.password?.[0] || 'Ошибка регистрации';
                showMessage(error, 'error');
            }
        } catch (error) {
            showMessage('Сервер недоступен', 'error');
        }
    });

    // Обработка входа
    document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            username: document.getElementById('login-username').value,
            password: document.getElementById('login-password').value
        };

        try {
            const response = await fetch(API_BASE_URL + 'login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            
            if (response.ok) {
                localStorage.setItem('lyriquest_auth_token', data.access);
                window.location.href = '/';
            } else {
                showMessage(data.detail || 'Неверные учетные данные', 'error');
            }
        } catch (error) {
            showMessage('Сервер недоступен', 'error');
        }
    });

    // Показать сообщение
    function showMessage(text, type) {
        const msgElement = document.getElementById('auth-message');
        msgElement.textContent = text;
        msgElement.className = `alert alert-${type}`;
        msgElement.style.display = 'block';
        
        setTimeout(() => {
            msgElement.style.display = 'none';
        }, 5000);
    }
</script>
{% endblock %}